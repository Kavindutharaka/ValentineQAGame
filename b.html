<!DOCTYPE html>
<html lang="en" ng-app="playerApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Real Temptation - Player B</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="questions.js"></script>
</head>
<body>
<div class="container" ng-controller="PlayerCtrl" ng-cloak>

    <!-- LOGO - always visible -->
    <div class="logo-wrap">
        <img src="logo.png" alt="Logo">
    </div>

    <!-- PAGE 1: Waiting for game to start -->
    <div class="page" ng-class="{active: currentPage === 'splash'}">
        <div class="splash-subtitle">Q&A Challenge</div>
        <div class="waiting-text">Waiting for game to start...</div>
        <div class="dots-loader">
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- PAGE 3-7: Questions (one at a time) -->
    <div class="page" ng-class="{active: currentPage === 'question'}">
        <div class="progress-bar-wrap">
            <div class="progress-bar-fill" ng-style="{'width': ((currentQuestionIndex + 1) / 5 * 100) + '%'}"></div>
        </div>
        <div class="timer-wrap">
            <div class="timer-bar-track">
                <div class="timer-bar-fill" ng-class="timerClass" ng-style="{'width': (timeLeft / maxTime * 100) + '%'}"></div>
            </div>
            <div class="timer-number" ng-class="timerClass">{{timeLeft}}</div>
        </div>
        <div class="question-header">Question {{currentQuestionIndex + 1}} of 5</div>
        <div class="question-text">{{currentQuestion.text}}</div>
        <div class="options-list">
            <button class="option-btn"
                    ng-repeat="opt in currentQuestion.options"
                    ng-class="{selected: selectedAnswer === opt}"
                    ng-click="selectAnswer(opt)">
                {{opt}}
            </button>
        </div>
        <button class="btn btn-primary"
                ng-click="nextQuestion()"
                ng-disabled="!selectedAnswer"
                ng-show="selectedAnswer">
            {{currentQuestionIndex < 4 ? 'Next' : 'Finish'}}
        </button>
    </div>

    <!-- PAGE 8: Waiting for partner to finish questions -->
    <div class="page" ng-class="{active: currentPage === 'waiting_results'}">
        <div class="splash-title" style="font-size: 40px;">You're done!</div>
        <div class="waiting-text">Waiting for your partner to finish...</div>
        <div class="dots-loader">
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- PAGE 9: Score / Results -->
    <div class="page" ng-class="{active: currentPage === 'score'}">
        <div class="score-section">
            <div class="score-title">Your Results</div>
            <div class="score-subtitle">Let's see how well you know each other!</div>
            <div class="score-circle">
                <div class="score-number">{{matchCount}}/5</div>
                <div class="score-label">Matched</div>
            </div>
            <div class="results-list">
                <div class="result-item" ng-repeat="r in results" ng-class="{match: r.isMatch, mismatch: !r.isMatch}">
                    <div class="result-question">
                        <span class="result-icon">{{r.isMatch ? '&#10004;' : '&#10008;'}}</span>
                        {{r.questionText}}
                    </div>
                    <div class="result-answers">
                        <div><strong>You:</strong> {{r.myAnswer}}</div>
                        <div><strong>Partner:</strong> {{r.partnerAnswer}}</div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" ng-click="finishGame()" style="margin-top: 40px; margin-bottom: 40px;">
                Finish
            </button>
        </div>
    </div>

</div>

<script>
    var PLAYER = 'b';
    var API_BASE = 'api/game.php';
    var QUESTION_TIME = 10; // seconds per question — change this value to adjust timer

    angular.module('playerApp', [])
    .controller('PlayerCtrl', ['$scope', '$http', '$interval', function($scope, $http, $interval) {

        // ── State ──
        $scope.currentPage = 'splash';
        $scope.currentQuestionIndex = 0;
        $scope.currentQuestion = null;
        $scope.selectedAnswer = null;
        $scope.answers = [];
        $scope.gameQuestions = [];
        $scope.matchCount = 0;
        $scope.results = [];
        $scope.timeLeft = QUESTION_TIME;
        $scope.maxTime = QUESTION_TIME;
        $scope.timerClass = 'safe';

        var pollTimer = null;
        var resetPollTimer = null;
        var questionTimer = null;

        // ── Helper: cancel any active poll ──
        function stopAllPolls() {
            if (pollTimer) { $interval.cancel(pollTimer); pollTimer = null; }
            if (resetPollTimer) { $interval.cancel(resetPollTimer); resetPollTimer = null; }
            stopQuestionTimer();
        }

        function stopQuestionTimer() {
            if (questionTimer) { $interval.cancel(questionTimer); questionTimer = null; }
        }

        function startQuestionTimer() {
            stopQuestionTimer();
            $scope.timeLeft = QUESTION_TIME;
            $scope.timerClass = 'safe';
            questionTimer = $interval(function() {
                $scope.timeLeft--;
                // Update visual class based on proportion of time left
                if ($scope.timeLeft > Math.ceil(QUESTION_TIME * 0.33)) {
                    $scope.timerClass = 'safe';
                } else if ($scope.timeLeft > Math.ceil(QUESTION_TIME * 0.17)) {
                    $scope.timerClass = 'warning';
                } else {
                    $scope.timerClass = 'danger';
                }
                // Time's up
                if ($scope.timeLeft <= 0) {
                    stopQuestionTimer();
                    autoAdvance();
                }
            }, 1000);
        }

        // ── Auto-advance when timer expires ──
        function autoAdvance() {
            // Save answer (null if not selected)
            $scope.answers.push({
                questionIndex: $scope.gameQuestions[$scope.currentQuestionIndex],
                answer: $scope.selectedAnswer || 'No Answer'
            });

            if ($scope.currentQuestionIndex < 4) {
                $scope.currentQuestionIndex++;
                loadQuestion();
                startQuestionTimer();
            } else {
                submitAnswers();
            }
        }

        // ── Full reset: wipe client state, go to splash, wait for new game ──
        function fullReset() {
            stopAllPolls();
            $scope.currentPage = 'splash';
            $scope.currentQuestionIndex = 0;
            $scope.currentQuestion = null;
            $scope.selectedAnswer = null;
            $scope.answers = [];
            $scope.gameQuestions = [];
            $scope.matchCount = 0;
            $scope.results = [];
            $scope.timeLeft = QUESTION_TIME;
            $scope.timerClass = 'safe';
            pollForGameStart();
        }

        // ── Reset detection: polls DB to see if table was cleared ──
        // Used on waiting pages & score page so that tablet reset or
        // partner's Finish button brings everyone back to splash.
        function startResetDetection() {
            if (resetPollTimer) return; // already running
            resetPollTimer = $interval(function() {
                $http.get(API_BASE + '?action=check_status').then(function(res) {
                    // Table was truncated or no session → go to splash
                    if (!res.data.status || parseInt(res.data.status) === 0) {
                        fullReset();
                    }
                });
            }, 2000);
        }

        // ── On page load: check current DB state ──
        function initOnLoad() {
            $http.get(API_BASE + '?action=check_status').then(function(res) {
                var status = res.data.status ? parseInt(res.data.status) : 0;

                if (status >= 2 && !res.data.player_a_done && !res.data.player_b_done) {
                    // Both players filled by tablet, ready for questions
                    $scope.gameQuestions = res.data.questions;
                    startQuestions();
                } else if (status === 0 || status === 1) {
                    // No game or tablet still filling forms → splash + poll
                    fullReset();
                } else {
                    // Game in progress or done → splash + poll
                    fullReset();
                }
            }, function() {
                fullReset();
            });
        }

        // ── Poll: wait for tablet to submit both players (status becomes 2) ──
        function pollForGameStart() {
            pollTimer = $interval(function() {
                $http.get(API_BASE + '?action=check_status').then(function(res) {
                    if (res.data.status && parseInt(res.data.status) >= 2) {
                        $interval.cancel(pollTimer);
                        pollTimer = null;
                        $scope.gameQuestions = res.data.questions;
                        startQuestions();
                    }
                });
            }, 2000);
        }

        // ── Start Q&A ──
        function startQuestions() {
            stopAllPolls();
            $scope.currentQuestionIndex = 0;
            $scope.answers = [];
            loadQuestion();
            $scope.currentPage = 'question';
            startQuestionTimer();
        }

        function loadQuestion() {
            var qIndex = $scope.gameQuestions[$scope.currentQuestionIndex];
            $scope.currentQuestion = QUESTIONS[qIndex];
            $scope.selectedAnswer = null;
        }

        $scope.selectAnswer = function(opt) {
            $scope.selectedAnswer = opt;
        };

        $scope.nextQuestion = function() {
            stopQuestionTimer();
            $scope.answers.push({
                questionIndex: $scope.gameQuestions[$scope.currentQuestionIndex],
                answer: $scope.selectedAnswer
            });

            if ($scope.currentQuestionIndex < 4) {
                $scope.currentQuestionIndex++;
                loadQuestion();
                startQuestionTimer();
            } else {
                submitAnswers();
            }
        };

        // ── Submit answers ──
        function submitAnswers() {
            $http.post(API_BASE + '?action=save_answers', {
                player: PLAYER,
                answers: $scope.answers
            }).then(function(res) {
                if (res.data.both_done) {
                    fetchAndShowResults();
                } else {
                    $scope.currentPage = 'waiting_results';
                    pollForPartnerDone();
                    startResetDetection();
                }
            });
        }

        // ── Poll for partner to finish answering ──
        function pollForPartnerDone() {
            pollTimer = $interval(function() {
                $http.get(API_BASE + '?action=check_partner_done&player=' + PLAYER).then(function(res) {
                    if (res.data.partner_done) {
                        $interval.cancel(pollTimer);
                        pollTimer = null;
                        if (resetPollTimer) { $interval.cancel(resetPollTimer); resetPollTimer = null; }
                        fetchAndShowResults();
                    }
                });
            }, 2000);
        }

        // ── Fetch results and show score ──
        function fetchAndShowResults() {
            stopAllPolls();
            $http.get(API_BASE + '?action=check_status').then(function(res) {
                var session = res.data;
                var myAnswers = PLAYER === 'a' ? session.player_a_answers : session.player_b_answers;
                var partnerAnswers = PLAYER === 'a' ? session.player_b_answers : session.player_a_answers;
                var questionIndices = session.questions;

                $scope.matchCount = 0;
                $scope.results = [];

                for (var i = 0; i < myAnswers.length; i++) {
                    var qIdx = questionIndices[i];
                    var isMatch = myAnswers[i].answer === partnerAnswers[i].answer;
                    if (isMatch) $scope.matchCount++;

                    $scope.results.push({
                        questionText: QUESTIONS[qIdx].text,
                        myAnswer: myAnswers[i].answer,
                        partnerAnswer: partnerAnswers[i].answer,
                        isMatch: isMatch
                    });
                }

                $scope.currentPage = 'score';
                // Start watching for reset (tablet "New Game" or partner "Finish")
                startResetDetection();
            });
        }

        // ── Finish button on score page ──
        $scope.finishGame = function() {
            stopAllPolls();
            $http.get(API_BASE + '?action=reset').then(function() {
                fullReset();
            });
        };

        // ── Boot ──
        initOnLoad();

    }]);
</script>
</body>
</html>
