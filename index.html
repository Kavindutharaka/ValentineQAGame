<!DOCTYPE html>
<html lang="en" ng-app="tabletApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Temptation - Start Game</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100vh;
            min-height: 100vh;
        }
        .tablet-form {
            width: 90%;
            max-width: 500px;
            text-align: left;
        }
        .tablet-form label {
            display: block;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            margin-top: 20px;
            color: #ffffff;
        }
        .tablet-form input {
            width: 100%;
            padding: 14px 18px;
            font-size: 18px;
            font-family: 'Poppins', sans-serif;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 14px;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            outline: none;
            transition: border-color 0.3s, background 0.3s;
        }
        .tablet-form input::placeholder {
            color: rgba(255,255,255,0.4);
        }
        .tablet-form input:focus {
            border-color: #e91e90;
            background: rgba(255,255,255,0.15);
        }
        .tablet-form .form-step-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 5px;
        }
        .tablet-form .form-step-badge {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            opacity: 0.6;
            margin-bottom: 10px;
        }
        .step-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .step-dots span {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            transition: all 0.3s ease;
        }
        .step-dots span.active {
            background: #e91e90;
            transform: scale(1.3);
        }
        .step-dots span.done {
            background: #4caf50;
        }
        .tablet-btn-row {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        .btn-tablet {
            padding: 14px 40px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-tablet.primary {
            background: linear-gradient(135deg, #e91e90, #ff6b9d);
            color: #ffffff;
            box-shadow: 0 6px 20px rgba(233, 30, 144, 0.4);
        }
        .btn-tablet.primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-tablet.secondary {
            background: rgba(255,255,255,0.15);
            color: #ffffff;
            border: 2px solid rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="tablet-body" ng-controller="TabletCtrl" ng-cloak>

    <div class="logo-wrap">
        <img src="logo.png" alt="Logo">
    </div>

    <!-- STATE: Idle -->
    <div ng-show="state === 'idle'">
        <!-- <div class="tablet-title">Real Temptation</div> -->
        <div class="tablet-subtitle">Couples Q&A Challenge</div>
        <button class="btn btn-primary btn-start" ng-click="startGame()">
            Start Game
        </button>
    </div>

    <!-- STATE: Player A form -->
    <div ng-show="state === 'form_a'" style="display:flex;flex-direction:column;align-items:center;">
        <div class="tablet-form">
            <div class="step-dots">
                <span class="active"></span>
                <span></span>
            </div>
            <div class="form-step-badge">Partner 1</div>
            <div class="form-step-title">Enter Details</div>
            <label>Name</label>
            <input type="text" ng-model="playerAName" placeholder="Enter name" autocomplete="off">
            <label>Mobile Number</label>
            <input type="tel" ng-model="playerAMobile" placeholder="Enter mobile number" autocomplete="off">
            <div class="tablet-btn-row">
                <button class="btn-tablet secondary" ng-click="backToIdle()">Back</button>
                <button class="btn-tablet primary"
                        ng-click="goToFormB()"
                        ng-disabled="!playerAName || !playerAMobile">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- STATE: Player B form -->
    <div ng-show="state === 'form_b'" style="display:flex;flex-direction:column;align-items:center;">
        <div class="tablet-form">
            <div class="step-dots">
                <span class="done"></span>
                <span class="active"></span>
            </div>
            <div class="form-step-badge">Partner 2</div>
            <div class="form-step-title">Enter Details</div>
            <label>Name</label>
            <input type="text" ng-model="playerBName" placeholder="Enter name" autocomplete="off">
            <label>Mobile Number</label>
            <input type="tel" ng-model="playerBMobile" placeholder="Enter mobile number" autocomplete="off">
            <div class="tablet-btn-row">
                <button class="btn-tablet secondary" ng-click="backToFormA()">Back</button>
                <button class="btn-tablet primary"
                        ng-click="submitBothPlayers()"
                        ng-disabled="!playerBName || !playerBMobile">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- STATE: Submitting -->
    <div ng-show="state === 'submitting'">
        <div class="waiting-text">Starting the challenge...</div>
        <div class="dots-loader">
            <span></span><span></span><span></span>
        </div>
    </div>

    <!-- STATE: Game running -->
    <div ng-show="state === 'running'">
        <div class="tablet-title">Game In Progress</div>
        <div class="tablet-subtitle">Players are answering questions on the kiosks</div>
        <div class="waiting-text small">Waiting for players to finish...</div>
        <div class="dots-loader">
            <span></span><span></span><span></span>
        </div>
        <div style="margin-top: 60px;">
            <button class="btn btn-primary" ng-click="resetGame()" style="background: linear-gradient(135deg, #cc0000, #ff4444); box-shadow: 0 8px 30px rgba(204,0,0,0.4); font-size: 22px; padding: 16px 50px;">
                Reset Game
            </button>
        </div>
    </div>

    <!-- STATE: Game finished -->
    <div ng-show="state === 'finished'">
        <div class="tablet-title">Game Complete!</div>
        <div class="tablet-subtitle">Scores are displayed on the kiosks</div>
        <div style="margin-top: 60px;">
            <button class="btn btn-primary btn-start" ng-click="resetGame()">
                New Game
            </button>
        </div>
    </div>

    <script>
        var API_BASE = 'api/game.php';

        angular.module('tabletApp', [])
        .controller('TabletCtrl', ['$scope', '$http', '$interval', function($scope, $http, $interval) {
            $scope.state = 'idle';
            $scope.playerAName = '';
            $scope.playerAMobile = '';
            $scope.playerBName = '';
            $scope.playerBMobile = '';

            var statusPoll = null;

            function stopPoll() {
                if (statusPoll) { $interval.cancel(statusPoll); statusPoll = null; }
            }

            function clearForms() {
                $scope.playerAName = '';
                $scope.playerAMobile = '';
                $scope.playerBName = '';
                $scope.playerBMobile = '';
            }

            function startStatusPoll() {
                stopPoll();
                statusPoll = $interval(function() {
                    $http.get(API_BASE + '?action=check_status').then(function(res) {
                        var status = res.data.status ? parseInt(res.data.status) : 0;
                        if (status === 0) {
                            stopPoll();
                            clearForms();
                            $scope.state = 'idle';
                        } else if (status === 4) {
                            stopPoll();
                            $scope.state = 'finished';
                        }
                    });
                }, 3000);
            }

            // On load: check existing session
            $http.get(API_BASE + '?action=check_status').then(function(res) {
                var status = res.data.status ? parseInt(res.data.status) : 0;
                if (status >= 2 && status < 4) {
                    $scope.state = 'running';
                    startStatusPoll();
                } else if (status === 1) {
                    // Game started but players not filled yet — go to form A
                    $scope.state = 'form_a';
                } else if (status === 4) {
                    $scope.state = 'finished';
                } else {
                    $scope.state = 'idle';
                }
            });

            // Step 1: Start game (creates session with status=1 and random questions)
            $scope.startGame = function() {
                $http.get(API_BASE + '?action=start').then(function(res) {
                    if (res.data.success) {
                        $scope.state = 'form_a';
                    }
                }, function() {
                    alert('Failed to connect to server. Please check the connection.');
                });
            };

            // Step 2: Go to Player B form
            $scope.goToFormB = function() {
                $scope.state = 'form_b';
            };

            // Back buttons
            $scope.backToIdle = function() {
                $http.get(API_BASE + '?action=reset').then(function() {
                    clearForms();
                    $scope.state = 'idle';
                });
            };

            $scope.backToFormA = function() {
                $scope.state = 'form_a';
            };

            // Step 3: Submit both players to DB, status → 2, kiosks detect and start questions
            $scope.submitBothPlayers = function() {
                $scope.state = 'submitting';
                $http.post(API_BASE + '?action=save_both_players', {
                    player_a_name: $scope.playerAName,
                    player_a_mobile: $scope.playerAMobile,
                    player_b_name: $scope.playerBName,
                    player_b_mobile: $scope.playerBMobile
                }).then(function(res) {
                    if (res.data.success) {
                        $scope.state = 'running';
                        startStatusPoll();
                    }
                }, function() {
                    alert('Failed to save player details.');
                    $scope.state = 'form_b';
                });
            };

            $scope.resetGame = function() {
                stopPoll();
                $http.get(API_BASE + '?action=reset').then(function() {
                    clearForms();
                    $scope.state = 'idle';
                });
            };
        }]);
    </script>
</body>
</html>
